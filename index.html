<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>reveal.js</title>

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/black-contrast.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />

    <style>
      body {
        --primary: rgb(247, 247, 148);
        --secondary: #654ff0;
        --tertiary: #00add8;
      }

      p {
        text-align: start;
      }
      p.header {
        font-size: 1.3em;
        font-weight: bold;
        text-align: start;
        color: var(--primary);
      }
      .small {
        font-size: 0.7em;
      }
      li {
        font-size: 0.8em;
      }
      ul {
        width: 100%;
      }

      .inline-img {
        display: inline;
        width: 1em;
        position: relative;
        top: 0.5em;
        left: 0.25em;
        margin-right: 0.5em;
      }

      .mrp5 {
        margin-right: 0.5em;
      }
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <p class="header">Yoke: An Exploration into Infrastructure as Code (IaC) and Kubernetes Package Management</p>
          <p class="fragment small" style="color: cyan">
            (A story from a platform engineer who wants to move beyond YAML for good)
          </p>
        </section>

        <section>
          <p class="header">Kubernetes APIs and the Manifest Conflation</p>
          <ul style="font-size: 0.8em">
            <li class="fragment">K8s offers APIs for creating and managing resources</li>
            <li class="fragment">
              Resources are repesented in their entirety and K8s calculates the diff and applies it
            </li>
            <li class="fragment">These APIs are encoded as YAML Manifests and are synced with K8s clusters</li>
            <li class="fragment">A set of manifests that together define an application is a package</li>
            <li class="fragment">We make packages configurable and reusable via templating</li>
          </ul>
        </section>

        <section>
          <p class="header">In a word:</p>
          <img class="fragment r-fit-text" style="width: 30%" src="/imgs/helm.svg" />
          <p class="fragment">The defacto solution for K8s Package Management</p>
        </section>

        <section>
          <p class="header">
            A Healthy Dose of
            <img
              src="/imgs/reddit.svg"
              style="display: inline; width: 1em; position: relative; top: 0.5em; left: 0.25em"
            />

            <span class="fragment"><br />(üçí picking)</span>
          </p>
          <p class="fragment">
            ‚ÄúHelm templating language was a mistake. > 90% of helm chart commits are bug fixes for indent‚Äù
          </p>
          <p class="fragment">‚ÄúHelm makes it overly complex, or is it just me?‚Äù</p>
          <p class="fragment">‚ÄúWhy Helm's design is flawed‚Äù</p>
        </section>

        <section>
          <p class="header">The Issues with Helm</p>
          <ul>
            <li class="fragment">not statically typed</li>
            <li class="fragment">sensitive to typos and indentations</li>
            <li class="fragment">no builtin testing</li>
            <li class="fragment">difficult to express complicated logic or do on the fly computations</li>
            <li class="fragment">manually need to maintain schema and values - most projects forgo schemas</li>
            <li class="fragment">inconsistent experience between editors (pay-to-play)</li>
            <li class="fragment">no documentation generation - read the <em>YAML</em></li>
          </ul>
        </section>

        <section>
          <p class="header">Question: How it is solved?</p>
          <p class="fragment" style="color: var(--tertiary)"><strong>Answer: More tooling</strong></p>
          <div style="display: flex; justify-content: space-between">
            <div>
              <p class="fragment small">Bespoke test frameworks:</p>
              <ul>
                <li class="fragment"><a href="https://github.com/helm-unittest/helm-unittest">helm-unittest</a></li>
                <li class="fragment"><a href="https://github.com/silphid/testchart">testchart</a></li>
                <li class="fragment">...</li>
              </ul>
            </div>
            <div>
              <p class="fragment small">Schemas and Data Validation:</p>
              <ul>
                <li class="fragment"><a href="https://cuelang.org/">Cue</a></li>
                <li class="fragment"><a href="https://json-schema.org/">JSON Schema</a></li>
                <li class="fragment">...</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <p class="header">Coming back through the looking glass</p>
          <p class="fragment small" style="color: var(--tertiary)">Why YAML?</p>
          <p class="fragment small" style="color: var(--tertiary)">Why templates?</p>
          <p class="fragment small">
            K8s resources differ fundamentally from web pages, emails, and push notifications
          </p>
          <p class="fragment small">Resources are structured data</p>
          <p class="fragment small">
            The most effective tools for handling structured data are
            <span style="color: var(--primary); font-weight: bold">programming languages</span>
          </p>
        </section>

        <section>
          <p class="header">What is a Helm Chart?</p>
          <hr />
          <p>
            <span class="fragment mrp5">values.yaml <img class="inline-img" src="/imgs/file.svg" /></span>
            <span class="fragment mrp5">+</span>
            <span class="fragment mrp5">templates <img class="inline-img" src="/imgs/files.svg" /></span>
            <span class="fragment mrp5">=</span>
            <span class="fragment mrp5">manifests <img class="inline-img" src="/imgs/files.svg" /></span>
          </p>

          <hr class="fragment" style="margin: 1em 0" />
          <p class="header fragment">What is a Code Package?</p>
          <p>
            <span class="fragment mrp5">Input</span>
            <span class="fragment mrp5">+</span>
            <span class="fragment mrp5" style="color: var(--tertiary); font-style: italic">f(x)</span>
            <span class="fragment mrp5">=</span>
            <span class="fragment mrp5">Output / K8s API resource(s)</span>
          </p>
          <hr class="fragment" style="margin: 1em 0" />
          <p class="fragment" style="color: var(--secondary)">A Helm Chart is a subset of Code Packages</p>
        </section>

        <section>
          <p class="header">Advantages of describing packages as code</p>
          <ul>
            <li class="fragment">fully fledged developer environment</li>
            <li class="fragment">discoverable contracts / compiler errors / static type checking</li>
            <li class="fragment">control flow</li>
            <li class="fragment">builtin testing</li>
            <li class="fragment">
              packaging, distribution and versioning is already solved: cargo, go modules, npm, and so on
            </li>
          </ul>
        </section>

        <section>
          <p class="header">Code Packages: TLDR;</p>
          <p class="fragment">Packages are programs that output Kubernetes resources</p>
          <p class="fragment">We can share packages by sharing code</p>
        </section>

        <section>
          <p class="header">Challenges</p>
          <hr />
          <p class="fragment small" style="color: var(--tertiary)">How do we package code?</p>
          <hr class="fragment" />
          <p class="fragment small">Tools will want to execute our packages.</p>
          <p class="fragment small">How can we support different languages? Different architectures?</p>
          <hr class="fragment" />
          <p class="fragment small" style="color: var(--tertiary)">How de we run code securely?</p>
          <hr class="fragment" />
          <p class="fragment small">Third party code shouldn't be allowed to do arbitrary operations</p>
          <p class="fragment small" style="font-weight: bolder; color: var(--secondary)">or access our clusters...</p>
        </section>

        <section>
          <img style="width: 10em" src="/imgs/wasm.svg" />
        </section>

        <section>
          <p class="header">Webassembly as package format</p>
          <ul>
            <li class="fragment">
              One target for multiple languages and ecosystems, supported by: <span style="color: #00add8">go</span>,
              <span style="color: orangered">rust</span>, <span style="color: yellow">zig</span>, and so on...
            </li>
            <li class="fragment">Sandboxed runtime without access to the filesystem or network.</li>
            <li class="fragment">Single asset that is easy to host, download, checksum, and execute.</li>
            <li class="fragment">Independent of OS Architecture</li>
          </ul>
        </section>

        <section>
          <p class="header">Yoke: The experimental IaC Package Manager for K8s</p>

          <p class="fragment small">
            Yoke executes wasm programs, and creates a release from the output, tracking revisions accross time like
            helm.
          </p>
          <p class="fragment small">In Yoke, packages, or programs that output K8s resources, are called Flights.</p>
        </section>

        <section>
          <p class="header">Demo Flight:</p>
          <pre
            class="fragment"
            data-id="code-animation"
          ><code style="padding: 1em; border-radius: 0.25em; font-size: 0.8em;" class="hljs golang" data-trim data-line-numbers="|1|9-11|25-27|29-40|42-45|47-49|51"><script type="text/template">
            package main

            import (
            	"encoding/json"
            	"flag"
            	"fmt"
            	"os"

            	appsv1 "k8s.io/client-go/applyconfigurations/apps/v1"
            	corev1 "k8s.io/client-go/applyconfigurations/core/v1"
            	metav1 "k8s.io/client-go/applyconfigurations/meta/v1"
            )

            func main() {
            	if err := run(); err != nil {
            		fmt.Fprintln(os.Stderr, err)
            		os.Exit(1)
            	}
            }

            func run() error {
            	name := os.Args[0] + "-demo"
            	labels := map[string]string{"app": name}
            
            	replicas := flag.Int("replicas", 2, "replica count")
            
            	flag.Parse()
            
            	podTemplate := corev1.PodTemplateSpec().
            		WithLabels(labels).
            		WithSpec(
            			corev1.
            				PodSpec().
            				WithContainers(
            					corev1.Container().
            						WithName(name).
            						WithImage("alpine:latest").
            						WithCommand("watch", "echo", "hello", "world"),
            				),
            		)
            
            	spec := appsv1.DeploymentSpec().
            		WithReplicas(int32(*replicas)).
            		WithSelector(metav1.LabelSelector().WithMatchLabels(labels)).
            		WithTemplate(podTemplate)
            
            	deployment := appsv1.Deployment(name, "").
            		WithLabels(labels).
            		WithSpec(spec)
            
            	return json.NewEncoder(os.Stdout).Encode([]any{deployment})
            }
					</script></code></pre>
        </section>
      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });
    </script>
  </body>
</html>
